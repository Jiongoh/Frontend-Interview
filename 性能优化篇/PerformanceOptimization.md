# 性能优化

#### 1. CDN的概念

CDN英文全称Content Delivery Network，中文名为内容分发网络。类似于电商平台在全国各地增设的仓库，是指一种通过互联网互相连接的电脑网络系统，利用最靠近每位用户的服务器，更快、更可靠地将音乐、图片、视频、应用程序及其他文件发送给用户，来提供高性能、可扩展性及低成本的网络内容传递给用户。

典型的CDN系统由三个部分组成：

- 分发服务系统：离用户在距离、任务载量等方面都是最合适的一台服务器，负责直接响应最终用户的访问请求，把缓存在本地的内容快速地提供给用户
- 负载均衡系统：主要功能是负责对所有发起服务请求的用户进行访问调度，确定提供给用户的最终实际访问地址，其工作最主要的原则就是就近原则
- 运营管理系统：负责处理业务层面的与外界系统交互所必须的收集、整理、交付工作，包含客户管理、产品管理、计费管理、统计分析等功能

------

#### 2. CDN的作用

CDN一般会用来托管Web资源（包括文本、图片和脚本等），可供下载的资源（媒体文件、软件、文档等），应用程序（门户网站等）。使用CDN来加速这些资源的访问。

- 性能方面的作用：
  1. 用户收到的内容来自最近的数据中心，延迟更低，内容加载更快
  2. 部分资源请求分配给了CDN，减少了源服务器的负载
- 安全方面的作用：
  1. 针对DDoS：通过监控分析异常流量，限制其请求频率
  2. 针对MIMT：CDN服务器到源服务器的各个节点都使用HTTPS通信

------

#### 3. CDN工作流程原理

- 用户输入URL后，本地DNS服务器发现该URL是一个**CDN专用的DNS服务器**，DNS系统就会将域名解析权交给CDN专用的DNS服务器
- CND专用DNS服务器将**全局负载均衡服务器**IP地址返回给用户，本地DNS服务器向全局负载均衡服务器发送数据请求
- 全局负载均衡服务器根据用户的IP地址，以及用户请求的内容URL，选择一台用户所属区域的**区域负载均衡服务器**，告诉用户向这台设备发起请求
- 区域负载均衡服务器选择一台合适的缓存服务器来提供服务，将该缓存服务器的IP地址返回给全局负载均衡服务器
- 全局负载均衡服务器把**缓存服务器**的IP地址返回给用户
- 用户向该缓存服务器发起请求，缓存服务器响应用户的请求，将用户所需内容发送至用户终端
- 如果缓存服务器没有用户想要的内容，那么缓存服务器就会向它的上一级缓存服务器请求内容，以此类推，直到回到源服务器获取资源

------

#### 4. 懒加载的概念

懒加载也叫做延迟加载、按需加载，指的是在滚动屏幕之前，可视化区域之外的图片/路由组件不会进行加载，在滚动屏幕时才加载。这样使得网页/组件的加载速度更快，减少了服务器的负载。

------

#### 5.  懒加载的优势

- 减少无用资源的加载：减少了服务器的压力和流量，同时也减小了浏览器的负担
- 提升用户体验：如果同时加载较多图片，可能需要等待的时间较长，这样影响了用户体验，而使用懒加载就能大大的提高用户体验
- 防止加载过多图片而影响其他资源文件的加载而导致网页无影响

------

#### 6. 懒加载的原理以及实现

- 图片的懒加载：

  图片的加载是由`src`引起的，当对`src`赋值时，浏览器就会请求图片资源。根据这个原理可以事先存储好图片的路径，需要加载图片时再将路径赋值给`src`，这样就实现了图片懒加载。懒加载的实现重点在于确定用户需要加载哪张图片，在浏览器中，可视区域内的资源就是用户需要的资源。所以当图片出现在可视区域时，获取图片的真实地址并赋值给图片即可。

  使用原生JS实现思路：`window.innerHeight` 是浏览器可视区的高度，`document.body.scrollTop || document.documentElement.scrollTop` 是浏览器滚动的过的距离，`imgs.offsetTop` 是图片元素顶部距离文档顶部的高度（包括滚动条的距离）。当***图片元素顶部距离文档顶部的高度*<u>小于</u>*浏览器可视区的高度*<u>加上</u>*浏览器滚动的过的距离*时**，就是图片加载的条件，即：`imgs.offsetTop < window.innerHeight + document.body.scrollTop`

- 路由的懒加载：

  路由懒加载是在配置路由时不直接引入路由组件，而是传递一个回调函数，回调函数内在对路由组件引入，就可以实现路由懒加载了。不使用路由懒加载时，当用户打开页面后，浏览器会将整个应用程序的JS文件都下载下来，也就是说整个应用程序的路由都已经加载好了，但如果使用了懒加载，浏览器则会先下载整个应用程序的基本框架和当前路径所对应的路由页面的JS文件，如果用户切换了使用了懒加载的路由，这时候浏览器才会去下载该路由的JS文件。

  对于Vue来说，在路由表内的component配置项中不直接写引入的路由组件，而是写入一个回调函数，在回调函数内引入路由组件，例如：

  ```js
  const routes = [
      {
          path: '/about',
          name: 'About',
          component: () =>
              import(/* webpackChunkName: "about" */ './About.vue')
      }
  ]
  ```

  对于React来说，需要额外引入`lazy()`API和Suspense组件配合使用，例如：

  ```jsx
  import { lazy, Suspense } from 'react';
  <Suspense>
      <Router path='/about' component={lazy(() => import('/about.jsx'))} />
  </Suspense>
  ```

------

#### 7. 回流（重排）与重绘的概念

- 回流：当渲染树中部分或者全部元素的尺寸、结构或者属性发生变化时，浏览器会重新渲染部分或者全部文档的过程就称为**回流**
- 重绘：当页面中某些元素的样式发生变化，但是不会影响其在文档流中的位置时，浏览器就会对元素进行重新绘制，这个过程就是**重绘**

> 注意： **当触发回流时，一定会触发重绘，但是重绘不一定会引发回流。**

------

#### 8. 如何避免回流与重绘

- 操作DOM时，尽量只操作底层级的DOM节点，操作层级过高的节点可能会导致其子节点全部回流
- 避免使用`table`布局，一个小的改动可能会使整个`table`进行重新布局
- 不要频繁操作元素的样式，对于静态页面，可以先写好类名对应的样式，再修改类名，而不是直接修改样式
- 使用absolute或者fixed，使元素脱离文档流，这样他们发生变化就不会影响其他元素
- 将元素先设置`display: none`，操作结束后再把它显示出来。因为在display属性为none的元素上进行的DOM操作不会引发回流和重绘。
- 将DOM的多个读操作（或者写操作）放在一起，而不是读写操作穿插着写

------

#### 9. 优化动画

一般情况下，动画需要频繁的操作DOM，就就会导致页面的性能问题，我们可以将动画的`position`属性设置为`absolute`或者`fixed`，将动画脱离文档流，这样他的回流就不会影响到页面了

------

#### 10. 节流与防抖

- 节流：指规定一个单位时间，在这个单位时间内，只能有一次触发事件的回调函数执行，如果在同一个单位时间内某事件被触发多次，只有一次能生效
- 防抖：指在事件被触发 n 秒后再执行回调，如果在这 n 秒内事件又被触发，则重新计时，可以避免用户发送过多的请求